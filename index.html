<!DOCTYPE>
<html>
  <head>

    <script src="https://SWI-Prolog.github.io/npm-swipl-wasm/4/0/10/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.1/codemirror.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.1/codemirror.min.css"></link>

    <style>
      .stderr { color: red; }
    </style>

    <script>
      function initCode() {
          (async () => {
              const swipl = await SWIPL({on_output: log, arguments: ["-q"]});
              window.Prolog = swipl.prolog;
              swipl.prolog.consult("elf","examples")
                  .then((ok,err) => {
                      let opts = document.getElementById("examples");
                      opts.onchange = _=>{
                          console.log("code: ", opts.value);
                          let code = Prolog.query(
                              "examples:ex(N,Code)",
                              {N: new Prolog.String(opts.value)}).once().Code.v;
                          editor.getDoc().setValue(code); };

                      let q = Prolog.query("examples:ex(N,_)");
                      let r;
                      do {
                          r = q.next();
                          opts.add(new Option(r.value.N.v, r.value.N.v));
                      } while(!r.done);
                  });
          })();

          let code = document.getElementById("code");
          code.value = localStorage.getItem("elfcode") || "# hello elf helper\n\"Hello World!\" print";
          var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
              lineNumbers: true,
              autoCLoseBrackets: true,
              matchBrackets: true
          });

          window.editor = editor;
      }

      window._FRAME=0;

      function run() {
          document.getElementById('result').innerHTML = "";
          let code = editor.getDoc().getValue();
          localStorage.setItem("elfcode", code);
          document.getElementById("log").innerHTML = ""; // clear log
          for(let r of Prolog.query("elf:run_string_pretty(Str, Result)", {Str: code})) {
              console.log(r.Result);
              document.getElementById('result').innerHTML = r.Result;
          }
      }

      function log(msg,to) {
          document.getElementById("log").innerHTML += `<div class="${to}">${msg}</div>`;
      }

    </script>

  </head>
  <body onload="initCode()">
    <select id="examples" title="Examples">
      <option value="">-- select example --</option>
    </select>
    <textarea id="code">[1 2 4] sum</textarea>
    <div>
      <button onclick="run()">run</button>
    </div>

    <div id="result"></div>
    <details open>
      <summary>Printed output</summary>
      <div id="log"></div>
    </details>

  </body>
</html>
